---
title: "Análisis Estadístico de las Finanzas Públicas Estatales en México: Egresos"
author: "Andrea Zamora"
format: html
editor: visual
---


```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r}
#| code-fold: true
#| message: false
#| warning: false

library(tidyverse)
library(RColorBrewer)
library(sf)          # Para datos espaciales
library(viridis)     # Para paletas de colores
library(DT)
library(plotly)
library(knitr)
library(kableExtra)
library(corrplot)
library(broom)
library(scales)
library(multcomp)
library(factoextra)
library(FactoMineR)
library(cluster)
library(ggsci)
library(ggpubr)
```

# Introducción

La Estadística de Finanzas Públicas Estatales y Municipales (EFIPEM) agrupa los egresos en 11 capítulos que ayudan a entender en qué se gasta el dinero público a nivel estatal. Con base en esta información, este análisis busca mostrar cómo han cambiado los patrones de gasto de los gobiernos estatales en México entre 2013-2023.


# Conceptos clave:

*Egresos Brutos:* Total de recursos que los gobiernos estatales y municipales utilizan para cubrir los gastos necesarios para cumplir sus funciones y programas. Esto lo realizan conforme a lo que marca su Presupuesto de Egresos y las leyes correspondientes.
Egresos brutos por capítulos:
  - Servicios personales
  - Materiales y suministros
  - Servicios generales
  - Transferencias, asignaciones, subsidios y otras ayudas
  - Bienes muebles, inmuebles e intangibles
  - Inversión pública
  - Inversiones financieras y otras provisiones
  - Recursos asignados a municipios
  - Deuda pública
  - Disponibilidad final
  - Otros

*Egresos Netos:* Son los gastos reales que se hacen durante un ejercicio fiscal, se excluye la disponibilidad final. La fórmula es: Egresos Netos = Egresos Brutos – Disponibilidad Final.

*Clasificadores utilizados:* La EFIPEM utiliza clasificadores oficiales que permiten presentar los datos de manera uniforme. Entre ellos destaca el: 
  - Clasificador por Objeto del Gasto (COG): Emitido por el CONAC, que ayuda a identificar en qué se está gastando.
  - Catálogo de Claves de la EFIPEM: Detalla los egresos en capítulos, conceptos, partidas y subpartidas para lograr una clasificación más precisa.


```{r}
data_sets <- list.files("./conjunto_de_datos", pattern = "*.csv", full.names = TRUE)
```

```{r}
datos <- data_sets |> 
  set_names(nm = data_sets) |> 
  map_dfr(read_csv, .id = "source_file")

datos_factor <- datos |> 
  dplyr::select(where(is.character)) |> 
  names()

datos <- datos |> 
  mutate(across(all_of(datos_factor), as_factor))

datos <- datos |> mutate(ANIO_factor = as_factor(ANIO), VALOR_millones = VALOR / 1e6)
datos <- datos |> rename(CVE_ENT = ID_ENTIDAD)

datos_estado <- read_csv("tc_entidad.csv")
datos_estado <- datos_estado |> mutate(across(everything(), as_factor))
datos_estado$ZONA <- factor(datos_estado$ZONA, levels = c("NORTE", "CENTRO", "SUR"))

datos <- left_join(datos, datos_estado)

datos <- datos |> dplyr::select(-source_file, -PROD_EST, -COBERTURA, -ESTATUS) 

nacional_estado <- st_read("data_nacional/00ent.shp", options = "ENCODING=LATIN1", quiet = TRUE)
nacional_estado <- left_join(nacional_estado, datos_estado, by = "CVE_ENT")



# Filtrar datos de egresos a nivel capítulo
egresos <- datos |> filter(TEMA == "Egresos", CATEGORIA == "Capítulo")

egresos <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    valor_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / valor_estado_anio) * 100
  ) |> 
  ungroup()

# Definir niveles de categoría para egresos
niveles_categoria_egresos <- c("Servicios personales", "Materiales y suministros", 
                               "Servicios generales", "Transferencias, asignaciones, subsidios y otras ayudas",
                               "Bienes muebles, inmuebles e intangibles", "Inversión pública",
                               "Inversiones financieras y otras provisiones", "Recursos asignados a municipios",
                               "Otros egresos", "Deuda pública", "Disponibilidad final")

egresos$DESCRIPCION_CATEGORIA <- factor(egresos$DESCRIPCION_CATEGORIA, 
                                       levels = niveles_categoria_egresos)

# Agregar columna de categorías principales para egresos
egresos <- egresos |> 
  mutate(
    CATEGORIA_PRINCIPAL = case_when(
      # Gastos Corrientes
      DESCRIPCION_CATEGORIA %in% c("Servicios personales", "Materiales y suministros", 
                                  "Servicios generales") ~ "Gastos Corrientes",
      
      # Transferencias y Asignaciones
      DESCRIPCION_CATEGORIA %in% c("Transferencias, asignaciones, subsidios y otras ayudas",
                                  "Recursos asignados a municipios") ~ "Transferencias y Asignaciones",
      
      # Inversión y Desarrollo
      DESCRIPCION_CATEGORIA %in% c("Inversión pública", 
                                  "Bienes muebles, inmuebles e intangibles") ~ "Inversión y Desarrollo",
      
      # Obligaciones Financieras
      DESCRIPCION_CATEGORIA %in% c("Deuda pública", 
                                  "Inversiones financieras y otras provisiones") ~ "Obligaciones Financieras",
      
      # Otros Egresos
      DESCRIPCION_CATEGORIA %in% c("Otros egresos", "Disponibilidad final") ~ "Otros Egresos"
    ),
    
    # Convertir a factor con orden específico
    CATEGORIA_PRINCIPAL = factor(CATEGORIA_PRINCIPAL, 
                                levels = c("Gastos Corrientes", "Transferencias y Asignaciones",
                                          "Inversión y Desarrollo", "Obligaciones Financieras", 
                                          "Otros Egresos"))
  )
```

```{r}
egresos_agregados <- egresos |> 
  group_by(ANIO, CVE_ENT, NOM_ENT, ABR_ENT, ZONA, CATEGORIA_PRINCIPAL, ANIO_factor) |> 
  summarise(
    VALOR = sum(VALOR, na.rm = TRUE),
    VALOR_millones = sum(VALOR_millones, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  
  # Calcular porcentaje por estado y año
  group_by(ANIO, CVE_ENT, NOM_ENT) |> 
  mutate(
    valor_estado_anio = sum(VALOR_millones, na.rm = TRUE),
    porcentaje_anual = (VALOR_millones / valor_estado_anio) * 100
  ) |> 
  ungroup() |> 
  
  # Reordenar columnas para mantener estructura similar
  dplyr::select(
    ANIO,
    CVE_ENT, 
    VALOR,
    ANIO_factor,
    VALOR_millones,
    porcentaje_anual,
    NOM_ENT,
    ABR_ENT,
    ZONA,
    CATEGORIA_PRINCIPAL
  )
```

```{r}
# Transformar a formato ancho con valor y porcentaje por categoría
egresos_wide <- egresos_agregados |> 
  dplyr::select(ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA, 
         CATEGORIA_PRINCIPAL, VALOR_millones, porcentaje_anual) |> 
  pivot_wider(
    names_from = CATEGORIA_PRINCIPAL,
    values_from = c(VALOR_millones, porcentaje_anual),
    names_sep = "_"
  ) |> 
  rename_with(
    ~ case_when(
      .x == "VALOR_millones_Gastos Corrientes" ~ "Gastos_Corrientes_valor",
      .x == "porcentaje_anual_Gastos Corrientes" ~ "Gastos_Corrientes_porcentaje",
      .x == "VALOR_millones_Transferencias y Asignaciones" ~ "Transferencias_Asignaciones_valor",
      .x == "porcentaje_anual_Transferencias y Asignaciones" ~ "Transferencias_Asignaciones_porcentaje",
      .x == "VALOR_millones_Inversión y Desarrollo" ~ "Inversion_Desarrollo_valor",
      .x == "porcentaje_anual_Inversión y Desarrollo" ~ "Inversion_Desarrollo_porcentaje",
      .x == "VALOR_millones_Obligaciones Financieras" ~ "Obligaciones_Financieras_valor",
      .x == "porcentaje_anual_Obligaciones Financieras" ~ "Obligaciones_Financieras_porcentaje",
      .x == "VALOR_millones_Otros Egresos" ~ "Otros_Egresos_valor",
      .x == "porcentaje_anual_Otros Egresos" ~ "Otros_Egresos_porcentaje",
      TRUE ~ .x
    )
  ) |> 
  # Reemplazar NA con 0 donde sea apropiado
  mutate(
    across(contains("_valor"), ~ replace_na(.x, 0)),
    across(contains("_porcentaje"), ~ replace_na(.x, 0))
  ) |> 
  # Reordenar columnas
  dplyr::select(
    ANIO, CVE_ENT, ANIO_factor, NOM_ENT, ABR_ENT, ZONA,
    Gastos_Corrientes_valor, Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_valor, Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_valor, Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_valor, Obligaciones_Financieras_porcentaje,
    Otros_Egresos_valor, Otros_Egresos_porcentaje
  )
```


## Estructura general

```{r}
# Tabla resumen de egresos
resumen_estructura_egresos <- egresos |> group_by(TEMA, CATEGORIA, ABR_ENT) |> 
  summarise(
    registros = n(),
    valor_total = sum(VALOR, na.rm = TRUE)/ 1e9,  # En miles de millones
    .groups = "drop"
  ) |> 
  arrange(TEMA, CATEGORIA, ABR_ENT)

kable(resumen_estructura_egresos, 
      col.names = c("Tema", "Categoría", "Entidad", "Registros", "Total (Miles Mill. MXN)"),
      digits = 2,
      caption = "Estructura General de Egresos EFIPEM 2014-2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cat("Las tablas que muestran el total de egresos acumulados por entidad permiten observar diferencias significativas de los presupuestos estatales")
```


## Composición de Egresos por Estado (2013-2023)

```{r}
# Calcular porcentajes de cada categoría por estado
porcentajes_categoria_estado_egresos <- egresos |> 
  group_by(NOM_ENT, ABR_ENT, DESCRIPCION_CATEGORIA) |> 
  summarise(valor_categoria = sum(VALOR_millones, na.rm = TRUE), .groups = "drop") |> 
  group_by(NOM_ENT, ABR_ENT) |> 
  mutate(
    total_estado = sum(valor_categoria),
    porcentaje = (valor_categoria / total_estado) * 100
  ) %>%
  ungroup()

# Gráfica de composición con etiquetas (solo categorías >5%)
graf_bar_egresos <- porcentajes_categoria_estado_egresos |> 
  mutate(etiqueta = ifelse(porcentaje >= 5, 
                          paste0(round(porcentaje, 1), "%"), 
                          "")) |> 
  ggplot(aes(x = reorder(ABR_ENT, total_estado), 
             y = porcentaje, 
             fill = DESCRIPCION_CATEGORIA)) +
  geom_col(position = "stack") +
  geom_text(aes(label = etiqueta), 
            position = position_stack(vjust = 0.5),
            size = 3, 
            color = "white",
            fontface = "bold") +
  coord_flip() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Composición de Egresos por Estado (2013-2023)",
    subtitle = "Porcentaje por capítulo (etiquetas >5%)",
    x = "Estado",
    y = "Porcentaje (%)",
    fill = "Capítulo de egreso"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 8),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  ) +
  guides(fill = guide_legend(nrow = 4, byrow = TRUE))

graf_bar_egresos
```


## Mapa de Egresos Totales por Estado

```{r}
agregado_mapa_egresos <- resumen_estructura_egresos |> 
  dplyr::select(ABR_ENT, valor_total)
agregado_mapa_egresos <- left_join(nacional_estado, agregado_mapa_egresos, by = "ABR_ENT")

mapa_egresos <- ggplot(agregado_mapa_egresos) +
  geom_sf(aes(fill = valor_total), color = "gray50", size = 0.5) +
  labs(
    title = "Egresos totales por estado (2013-2023)",
    subtitle = "Valores en miles de millones de MXN",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "Egresos Totales"
  ) +
  scale_fill_viridis_c(labels = comma) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

print(mapa_egresos)
```


###Sin el Estado de México para mejor visualización

```{r}
mapa_egresos_sin_mex <- ggplot(agregado_mapa_egresos |> filter(ABR_ENT != "MEX")) +
  geom_sf(aes(fill = valor_total), color = "gray50", size = 0.5) +
  labs(
    title = "Egresos totales por estado (2013-2023)",
    subtitle = "Valores en miles de millones de MXN (sin Estado de México)",
    caption = "Fuente: INEGI - Finanzas Públicas",
    fill = "Egresos Totales"
  ) +
  scale_fill_viridis_c(labels = comma) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10)
  )

print(mapa_egresos_sin_mex)
```


##Egresos por Categoría Principal (2013-2023)

```{r}
tabla_resumen_principal_egresos <- egresos |> 
  group_by(CATEGORIA_PRINCIPAL) |> 
  summarise(
    valor_millones = sum(VALOR_millones, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    porcentaje = (valor_millones / sum(valor_millones)) * 100,
    valor_billones = valor_millones / 1000000
  ) |> 
  arrange(desc(valor_millones))

tabla_resumen_principal_egresos %>%
  mutate(
    `Valor (Millones MXN)` = format(round(valor_millones, 0), big.mark = ",", scientific = FALSE),
    `Valor (Billones MXN)` = format(round(valor_billones, 2), nsmall = 2),
    `Porcentaje (%)` = format(round(porcentaje, 1), nsmall = 1)
  ) %>%
  dplyr::select(
    `Categoría Principal` = CATEGORIA_PRINCIPAL,
    `Valor (Millones MXN)`,
    `Valor (Billones MXN)`,
    `Porcentaje (%)`
  ) %>%
  kable(
    caption = "Egresos Estatales por Categoría Principal (2014-2023)",
    align = c("l", "r", "r", "r")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 12
  ) %>%
  add_header_above(c(" " = 1, "Valores Absolutos" = 2, "Relativo" = 1))
```


##Tendencias Temporales por Categoría Principal

```{r}
graf_temp_egresos <- ggplot(egresos_agregados, 
                    aes(x = ANIO, y = VALOR_millones, color = ABR_ENT)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ CATEGORIA_PRINCIPAL, scales = "free_y", ncol = 2) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = unique(egresos_agregados$ANIO)) +
  labs(
    title = "Tendencias Temporales de Egresos Estatales por Categoría Principal (2013-2023)",
    x = "Año",
    y = "Egresos (Millones MXN)",
    color = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 8),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10),
    strip.text = element_text(size = 10, face = "bold")
  )

ggplotly(graf_temp_egresos)
```


## Análisis de Servicios Personales

```{r}
ggplot(egresos_agregados |> filter(CATEGORIA_PRINCIPAL == "Gastos Corrientes"), 
       aes(x = reorder(ABR_ENT, porcentaje_anual, FUN = mean), y = porcentaje_anual,
           fill = ABR_ENT)) +
  geom_boxplot() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = "Distribución de Gastos Corrientes como Porcentaje de Egresos Totales (2013-2023)",
    subtitle = "Servicios personales, materiales y servicios generales",
    x = "Estado",
    y = "Porcentaje (%)",
    fill = "Estado"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "none",
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 11)
  )
```


## ANOVA por Categorías Principales

```{r}
# ANOVA para Gastos Corrientes
aov_gastos_corrientes <- aov(porcentaje_anual ~ ABR_ENT, 
                            data = egresos_agregados |> 
                            filter(CATEGORIA_PRINCIPAL == "Gastos Corrientes"))

cat("ANOVA - Gastos Corrientes:\n")
summary(aov_gastos_corrientes)
```


## Matriz de Correlación entre Categorías de Egresos

```{r}
variables_correlacion_egresos <- egresos_wide %>%
  dplyr::select(
    ANIO,
    Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_porcentaje,
    Otros_Egresos_porcentaje
  )

# Calcular matriz de correlación
matriz_correlacion_egresos <- cor(variables_correlacion_egresos, use = "complete.obs")

corrplot(matriz_correlacion_egresos, 
         method = "color",
         type = "upper",
         order = "hclust",
         tl.col = "black",
         tl.srt = 45,
         tl.cex = 0.8,
         addCoef.col = "black",
         number.cex = 0.7,
         title = "Matriz de Correlación - Egresos Estatales por Categoría Principal",
         mar = c(0,0,2,0))
```


## Análisis de Componentes Principales (PCA) para Egresos

## Preparación de datos para PCA

```{r}
# Seleccionar variables numéricas para PCA (porcentajes)
egresos_numeric_porcentaje <- egresos_wide |> 
  dplyr::select(
    Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_porcentaje,
    Otros_Egresos_porcentaje
  )

# Excluir Estado de México para análisis
egresos_wo_MEX <- egresos_wide |> filter(ABR_ENT != "MEX")
egresos_numeric_porcentaje_wo_MEX <- egresos_wo_MEX |> 
  dplyr::select(
    Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_porcentaje,
    Otros_Egresos_porcentaje
  )
```


## PCA en porcentajes de egresos 

```{r}
PC_porcentaje_egresos <- prcomp(egresos_numeric_porcentaje_wo_MEX, scale. = TRUE, center = TRUE)

eig_porcentaje_egresos <- get_eigenvalue(PC_porcentaje_egresos)
eig_tabla_egresos <- data.frame(
  PC = paste0("PC", 1:dim(eig_porcentaje_egresos)[1]), 
  Eigenvalor = round(eig_porcentaje_egresos$eigenvalue, 3), 
  Varianza = round(eig_porcentaje_egresos$variance.percent, 2), 
  Var_acu = round(eig_porcentaje_egresos$cumulative.variance.percent, 2)
)

kable(eig_tabla_egresos, align = "c", 
      col.names = c("Componente", "Eigenvalor", "% varianza", "% varianza acumulada")) %>%
  kable_styling(c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(width = "100%", height = "300px", fixed_thead = TRUE)
```


## Scree plot

```{r}
fviz_eig(PC_porcentaje_egresos, addlabels = TRUE) +
  labs(title = "Scree Plot - PCA Egresos Estatales")
```


## Coeficientes (Loadings)

```{r}
PC_coef_egresos <- data.frame(PC_porcentaje_egresos$rotation)
kable(PC_coef_egresos, align = "c") %>%
  kable_styling(c("striped", "hover"), full_width = FALSE) %>%
  scroll_box(width = "100%", height = "300px", fixed_thead = TRUE)
```


## Contribución variables

```{r}
fviz_pca_var(PC_porcentaje_egresos, 
             col.var = "contrib", 
             gradient.cols = c("#1627dc", "#ffb600", "#ff2e16"),
             title = "Contribución de Variables - PCA Egresos")
```


## Contribución PC1

```{r}
fviz_contrib(PC_porcentaje_egresos, "var", axes = 1) +
  labs(title = "Contribución a PC1 - Egresos")
```


## Contribución PC2

```{r}
fviz_contrib(PC_porcentaje_egresos, "var", axes = 2) +
  labs(title = "Contribución a PC2 - Egresos")
```


## *Proyecciones*


## Biplot

```{r}
fviz_pca_biplot(PC_porcentaje_egresos,
                geom.ind = "point",
                fill.ind = egresos_wo_MEX$ABR_ENT,
                pointshape = 21,
                pointsize = 2,
                alpha.ind = 0.6,
                col.var = "black",
                mean.point = FALSE,
                label = "var",
                repel = TRUE,
                title = "Biplot - PCA Egresos Estatales"
  )
```


##  Proyección de estados

```{r}
proy_scores_egresos <- fviz_pca_ind(PC_porcentaje_egresos,
             pointsize = 2,
             habillage = egresos_wo_MEX$ABR_ENT,
             mean.point = FALSE,
             label = "var",
             repel = TRUE,
             title = "Proyección de Estados - PCA Egresos"
  )

ggplotly(proy_scores_egresos)
```


## Análisis de Clustering para Egresos #Preparación de datos para clustering

```{r}
my_year <- 2018

egresos_year <- egresos_wide |> 
  filter(ANIO == my_year)

egresos_wo_MEX_year <- egresos_year |> filter(ABR_ENT != "MEX")

egresos_numeric_porcentaje_year <- egresos_wo_MEX_year |> 
  dplyr::select(
    Gastos_Corrientes_porcentaje,
    Transferencias_Asignaciones_porcentaje,
    Inversion_Desarrollo_porcentaje,
    Obligaciones_Financieras_porcentaje,
    Otros_Egresos_porcentaje
  )

row.names(egresos_numeric_porcentaje_year) <- egresos_wo_MEX_year$ABR_ENT
```


## Composición de Egresos por Estado (Año 2018)

```{r}
egresos_year_bar <- egresos_agregados |> 
  filter(ANIO == my_year) 

graf_bar_egresos_year <- egresos_year_bar |> 
  mutate(etiqueta = ifelse(porcentaje_anual >= 5, 
                          paste0(round(porcentaje_anual, 1), "%"), 
                          "")) |> 
  ggplot(aes(x = ABR_ENT, 
             y = porcentaje_anual, 
             fill = CATEGORIA_PRINCIPAL)) +
  geom_col(position = "stack") +
  geom_text(aes(label = etiqueta), 
            position = position_stack(vjust = 0.5),
            size = 3, 
            color = "white",
            fontface = "bold") +
  coord_flip() +
  scale_fill_viridis_d(option = "turbo") +
  labs(
    title = paste("Composición de Egresos por Estado -", my_year),
    subtitle = "Porcentaje por categoría principal (etiquetas >5%)",
    x = "Estado",
    y = "Porcentaje (%)",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.text = element_text(size = 8),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11)
  ) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE))

graf_bar_egresos_year
```


## Matriz de Distancias

```{r}
dist_eucl_egresos <- dist(egresos_numeric_porcentaje_year)
dist_eucl_matrix_egresos <- as.matrix(dist_eucl_egresos)
dist_eucl_plot_egresos <- fviz_dist(dist_eucl_egresos, lab_size = 6) +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 16, face = "bold")) +
  labs(title = "Matriz de Distancias Euclidianas - Egresos")

ggplotly(dist_eucl_plot_egresos)
```


## *Clustering Jerárquico*


## Método Complete

```{r}
euc_comp_hc_egresos <- hclust(dist_eucl_egresos, method = "complete")
fviz_dend(euc_comp_hc_egresos, k = 5, cex = 0.9, k_colors = "jco", 
          rect = TRUE, rect_border = "jco", rect_fill = TRUE, 
          labels_track_height = 3,
          main = "Dendrograma - Clustering Jerárquico (Complete)")
```

```{r}
grp_euc_complete_egresos <- cutree(euc_comp_hc_egresos, k = 5)
table(grp_euc_complete_egresos)
```

```{r}
fviz_cluster(
  list(
    data = egresos_numeric_porcentaje_year,
    cluster = grp_euc_complete_egresos
  ),
  palette = "jco",
  ellipse.type = "convex",
  repel = TRUE,
  show.clust.cent = FALSE,
  ggtheme = theme_bw(),
  main = "Clustering - Método Complete"
)
```


## Método Ward

```{r}
euc_ward_hc_egresos <- hclust(dist_eucl_egresos, method = "ward.D2")
fviz_dend(euc_ward_hc_egresos, k = 5, cex = 0.9, k_colors = "jco", 
          rect = TRUE, rect_border = "jco", rect_fill = TRUE, 
          labels_track_height = 3,
          main = "Dendrograma - Clustering Jerárquico (Ward)")
```


## *Clustering K-means*


## K = 3 clusters

```{r}
km3_egresos <- kmeans(egresos_numeric_porcentaje_year, 3, nstart = 25)
fviz_cluster(km3_egresos, 
             data = egresos_numeric_porcentaje_year, 
             palette = "jco", 
             ellipse.type = "euclid", 
             star.plot = TRUE, 
             ggtheme = theme_bw(),
             main = "K-means - 3 Clusters")
```


## K = 4 clusters

```{r}
km4_egresos <- kmeans(egresos_numeric_porcentaje_year, 4, nstart = 25)
fviz_cluster(km4_egresos, 
             data = egresos_numeric_porcentaje_year, 
             palette = "jco", 
             ellipse.type = "euclid", 
             star.plot = TRUE, 
             ggtheme = theme_bw(),
             main = "K-means - 4 Clusters")
```


## Mapas de Clustering

```{r}
# Preparar datos para mapas
grp_complete_df_egresos <- as.data.frame(grp_euc_complete_egresos)
grp_complete_df_egresos <- grp_complete_df_egresos |> 
  rownames_to_column(var = "ABR_ENT")

nacional_estado_egresos <- left_join(nacional_estado, grp_complete_df_egresos, by = "ABR_ENT")
nacional_estado_egresos$grp_euc_complete_egresos <- as.factor(nacional_estado_egresos$grp_euc_complete_egresos)

mapa_clustering_egresos <- ggplot(nacional_estado_egresos) +
  geom_sf(aes(fill = grp_euc_complete_egresos), color = "gray50", size = 0.5) +
  labs(
    title = "Clustering de Egresos por Estado - Método Complete",
    subtitle = paste("Año", my_year),
    fill = "Cluster"
  ) +
  scale_fill_brewer(palette = "Set3") +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )

print(mapa_clustering_egresos)
```


## Conclusiones

El análisis del gasto estatal entre 2013 y 2023 muestra que la mayor parte del presupuesto se va a rubros difíciles de mover, especialmente a transferencias y gastos corrientes.Las transferencias superan la mitad del gasto total, lo que abre poco espacio para que los estados puedan decidir libremente respecto a en qué destinar sus recursos. Por otro lado, los gastos administrativos también ocupan una parte relevante, lo que reduce el margen para destinar más recursos a la inversión pública.

También se encontró que no todos los estados gastan de la misma manera. Las diferencias que se detectan con ANOVA muestran que cada entidad tiene su propio estilo de administración y depende de  factores como la población, el desarrollo, la dependencia de los recursos federales y las prioridades del gobierno local.

Con el PCA se identificaron dos grandes tendencias: si su gasto es más del lado de las funciones administrativas o redistributivas y el equilibrio que mantienen entre la inversión y las obligaciones financieras.

Finalmente, por medio de técnicas de clustering, se agruparon a los estados en función de sus maneras de gastar. Esto nos ayuda para ver qué políticas se ajustan más a cada estado. 

